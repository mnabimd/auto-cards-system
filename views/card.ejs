<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('partials/head')%>
    <title>Generate new card - KDR University</title>
</head>

<body id="page-top">

    <!-- Page Wrapper -->
    <div id="wrapper">

        <!-- Sidebar -->
        <%- include('partials/sidebar')%>
        <!-- End of Sidebar -->

        <!-- Content Wrapper -->
        <div id="content-wrapper" class="d-flex flex-column">

            <!-- Main Content -->
            <div id="content">

                <!-- Topbar -->
                <%- include('partials/topbar')%>
                <!-- End of Topbar -->

                <!-- Begin Page Content -->
                <div class="container-fluid">
                    <!-- ---------------------------------------------------------------------- -->
                    <!-- Student Searching Form -->
                    <form action="/newCard" method="POST" style="width: 400px;">

                        <label>Input Student Kankor's ID</label>
                        <div class="input-group">
                            <input class="form-control" type="text" name="kankorId">
                            <input class="btn btn-primary" type="submit" value="Find Student">
                        </div>
                    </form>

                    <!-- Student Result  -->
                    <% if (data.student) {%>
                    <div class="student-bio mx-5 my-3">
                        <div class="card p-5" dir="rtl">
                            <style>
                                #student-profile {
                                    margin-right: auto;
                                    margin-left: auto;
                                    /* width: 150px; */
                                    height: 150px;
                                    border-radius: 50%;
                                }
                            </style>
                            <div class="d-flex flex-column align-items-center w-100">
                                <img id="student-profile" src="./card-template/images/images.png">
                            </div>

                            <form action="/cardLive" method="POST" class="font-weight-bold pashtoFont mt-5"
                                enctype="multipart/form-data">

                                <input id="image-uploaded" type="file" class="text-center"
                                    accept="image/x-png,image/gif,image/jpeg" name="profilePhoto"
                                    required="Please upload a profile photo!" />

                                <div class="form-row">
                                    <div class="col">
                                        <div class="form-group">
                                            <label for="name" class="pashtoFont float-right"> نوم</label>
                                            <input id="name-kankor" class="form-control my-input" type="text"
                                                name="name" value="<%= data.student.name %>">
                                        </div>
                                    </div>

                                    <div class="col">
                                        <div class="form-group">
                                            <label for="name" class="pashtoFont float-right"> د پلارنوم</label>
                                            <input id="fatherName-kankor" class="form-control my-input" type="text"
                                                name="fatherName" value="<%= data.student.fatherName %>">
                                        </div>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="col">
                                        <div class="form-group">
                                            <label class="pashtoFont float-right "> پوهنځی</label>
                                            <input id="faculty-kankor" class="form-control my-input" type="text"
                                                name="faculty" value="<%= data.student.faculty.name %>">
                                        </div>
                                    </div>

                                    <div class="col">
                                        <div class="form-group">
                                            <label class="pashtoFont float-right"> څانګه</label>
                                            <input id="branch-kankor" class="form-control my-input" type="text"
                                                name="branch" value="<%= data.student.faculty.branch %>">
                                        </div>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="col">
                                        <div class="form-group">
                                            <label class="pashtoFont float-right"> د وینی ګروپ</label>
                                            <input id="blood-kankor" class="form-control my-input" type="text"
                                                name="blood" value="A+">
                                        </div>
                                    </div>

                                    <div class="col">
                                        <div class="form-group">
                                            <label class="pashtoFont float-right">د شمولیت کال</label>
                                            <input id="yearOfKankor-kankor" class="form-control my-input" type="text"
                                             value="<%= data.student.yearOfKankor %>">
                                            
                                        </div>
                                    </div>


                                    <div class="col">
                                        <div class="form-group">
                                            <label class="pashtoFont float-right"> کارت ختم نیټه</label>
                                            <input id="yearOfKankor-kankor" class="form-control my-input" type="text"
                                                name="yearOfKankor" value="<%= parseInt(data.student.yearOfKankor + 4) %>/6/15">
                                        </div>
                                    </div>

                                    <div class="col">
                                        <div class="form-group">
                                            <label class="pashtoFont float-right">انګلیسی نوم</label>
                                            <!-- If the student english name was avaible on DB, then just fetch -->
                                            <%if (data.student.other.e_info && data.student.other.e_info.name) {%>
                                            <input id="e_name" name="eName" type="text"
                                                value="<%= data.student.other.e_info.name%>"
                                                class="form-control my-input" autocomplete="off">
                                            <%} else {%>
                                            <input id="e_name" name="eName" type="text" value=""
                                                class="form-control my-input">
                                            <%}%>
                                        </div>
                                    </div>

                                    <div class="hidden-values">

                                        <!-- The Kankor ID -->
                                        <input id="kankorId" type="text" value="<%= data.student.kankorId%>"
                                            name="kankorId"
                                            style="display: none;">

                                        <input type="text" value="<%= data.student._id%>" name="_id"
                                                style="display: none;">
                                        
                                        <input type="text" value="<%= data.student.gender%>" name="gender" style="display: none;">

                                        </div>

                                    </div>


                                    <button type="submit" class="btn btn-danger px-4"
                                        style="font-family:'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;">Live
                                        Preview
                                    </button>
                            </form>

                        </div>
                    </div>
                    <%} else if (data.message) {%>
                    <h2><%= data.message %></h2>
                    <%} %>
                    <!-- ---------------------------------------------------------------------- -->
                </div>
                <!-- /.container-fluid -->

            </div>
            <!-- End of Main Content -->

            <!-- Footer -->
            <%- include('partials/footer')%>
            <!-- End of Footer -->

        </div>
        <!-- End of Content Wrapper -->

    </div>
    <!-- End of Page Wrapper -->

    <!-- Scroll to Top Button-->
    <a class="scroll-to-top rounded" href="#page-top">
        <i class="fas fa-angle-up"></i>
    </a>

    <!-- Logout Modal-->
    <%- include('partials/modals/logout')%>

    <!-- Bootstrap core JavaScript-->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Core plugin JavaScript-->
    <script src="vendor/jquery-easing/jquery.easing.min.js"></script>

    <!-- Custom scripts for all pages-->
    <script src="js/sb-admin-2.min.js"></script>

    <!-- My Scripts:- -->
    <script src="./js/main/bundle.js"></script>

</body>

<script>
    const toBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });


    const elements = {
        studentImage: document.getElementById('student-profile'),
        imageUploaded: document.getElementById('image-uploaded'),
        formInputFileBuffer: document.getElementById('profileBuffer')
    }

    // Change student profile picture with the new updated one!:-
    elements.imageUploaded.addEventListener('change', async (e) => {

        const file = elements.imageUploaded.files[0];

        if (!file) return false;

        const fileData = await toBase64(file);

        elements.studentImage.src = fileData;

        // Profile Photo Info/name -> E.g : M27001717@Aziz Ahmad@A+ :-
        // M27001717 -> Copy to the clipboard
        // Aziz Ahmad -> To English input value
        // A+ -> To Blood input value
        // So, let's do this:-

        const formElements = {
            bloodInput: document.getElementById('blood-kankor'),
            eName: document.getElementById('e_name')
        }

        // If incase, there were no @ symbole in the name, return false:-
        if (file.name.indexOf('@') === -1) {
            return false;
        };
        let nameToValues = file.name.split('@').map(name => name.trim());
        nameToValues[2] = nameToValues[2].split('.')[0]; // This will remove the extension:-    

        // Okay, we're good to go:-
        // Now, we'll copy the [0] value to clipboard, because it would make life little easier for search
        if (formElements.eName && formElements.bloodInput) {
            // Now, let's do the magic!
            formElements.eName.value = nameToValues[1];
            formElements.bloodInput.value = nameToValues[2];
        }
        
    });
</script>

</html>